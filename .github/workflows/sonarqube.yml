name: SonarCloud Analysis

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

permissions:
  contents: read
  pull-requests: read
  statuses: write

concurrency:
  group: sonar-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sonar:
    name: Coverage & SonarCloud Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: neoboard_test
          POSTGRES_PASSWORD: neoboard_test
          POSTGRES_DB: neoboard_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: neo4j/neoboard123
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p neoboard123 'RETURN 1'"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: Checkout (full history for blame info)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            app/package-lock.json
            component/package-lock.json
            connection/package-lock.json

      - name: Install dependencies (all packages)
        run: |
          npm ci --prefix app
          npm ci --prefix component
          npm ci --prefix connection

      # ── App: Vitest unit coverage ──────────────────────────────────────────
      - name: Generate app coverage
        working-directory: app
        run: npm run test:coverage
        env:
          NODE_ENV: test

      # ── Component: Vitest unit coverage ───────────────────────────────────
      - name: Generate component coverage
        working-directory: component
        run: npm run test:coverage

      # ── Connection: Jest integration coverage ─────────────────────────────
      - name: Generate connection coverage
        working-directory: connection
        run: npm run test:coverage
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: neoboard_test
          POSTGRES_PASSWORD: neoboard_test
          POSTGRES_DB: neoboard_test
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: neoboard123

      # ── SonarCloud Scanner ────────────────────────────────────────────────
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
